#!/bin/bash
set -e

cbi=git://github.com/kuerzn/cbi.git
suparch="[none|arch|ubuntu]"
rev=$2
machine=$3
user=$4
#dd4c4d687fcde705bd061a45927386c936d006b7

#taken from https://github.com/falconindy/arch-install-scripts/blob/master/genfstab.in
usage() {
    cat <<EOF

     usage: ${0##*/} $suparch <revision> <machine> <user>
     
     This script does:

       - install Salt (from GIT, master-less minion, no service)
         unless <none>.
       - create GPG Machine Key  "j0@<machine>"
       - check out the CBI <revision> into <user>'s HOME
       - state.HighState from CBI
     
EOF
}

if (( EUID != 0 )); then
    echo "Run this script as root." 1>&2
    exit 100
fi


if [[ $# -ne 4  ]]; then
    usage
    exit $(( $# ? 0 : 1 ))
fi


checkout_cbi(){
		# 1. install git
		salt-call state.single pkg.installed name=git
		
		# 2. create user
		salt-call state.single user.present name=$user

    # 3. clone cbi
		home_cbi=`bash -c "echo ~$user"`/cbi
		git clone $cbi $home_cbi
		echo "asd"
				cd $home_cbi && \
				(	git checkout $rev
		if [ "$rev" = `git rev-parse HEAD` ]; then
				echo "OK"
				export PATH=$PATH:$home_cbi/bin

		# 4. generate machine key
				su -c "PATH=\$PATH:$home_cbi/bin; gpg-generate-machine-keys 0 $machine" $user

				
		fi
		)
		
		# salt-call state.single \
		# 		git.latest \
		# 		name=$cbi \
		# 		target=``/cbi \
		# 		runas=$user \
		# 		rev=dd4c4d687fcde705bd061a45927386c936d006b7
}

configure_salt() {
		cat <<EOF > /etc/salt/minion
master: localhost
file_client: local
file_roots:
  base:
    - $cbi_temp/salt
pillar_roots:
  base:
    - $cbi_temp/pillar
grains:
  cbi_machine: $machine
EOF

checkout_cbi
}

if command -v salt-call; then
		checkout_cbi
		exit $?
fi

case $1 in
    arch)
				(! grep -q  '#BOOTSTRAP' /etc/pacman.d/mirrorlist ) && \
						sed -i '1i Server = http://ftp.spline.inf.fu-berlin.de/mirrors/archlinux/$repo/os/$arch\n#BOOTSTRAP' /etc/pacman.d/mirrorlist
				pacman -Syy
				
				tp=/tmp/packer_tmp`uuidgen`
				
				#packer
				rm -rf $tp
				mkdir $tp && \
				(
						cd $tp && \
								curl -o PKGBUILD https://aur.archlinux.org/packages/pa/packer/PKGBUILD && \
								makepkg -s --asroot && \
								pacman --noconfirm -U *.tar.xz && \
								packer --noconfirm --noedit -S salt-git && \
								configure_salt
						rm -rf $tp
				)
        ;;
		
    ubuntu)
				install_path=/usr/share/salt-cbi
        apt-get update 
				apt-get install python python-jinja2 python-m2crypto python-support python-yaml python-zmq msgpack-python && \
						(rm $install_path -fr 
						mkdir $install_path -p
						cd $install_path
						git clone git://github.com/saltstack/salt.git && \
								cd salt && \
								python setup.py install && \
								configure_salt
				)
        ;;
		none)
				echo "Skipping Salt installation"
				;;
    *)
        echo "First argument must be one of $suparch not  '$1'"
        ;;
esac

