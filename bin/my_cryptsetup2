#!/bin/bash
# bash cannot store null values in variables
# 1. reads parameters fo dm-crypt from stdin
# 2. checks, if sha512(key) is stored at beginning of container
# 3. mappes container (skipping the first block)
cc="cryptsetup plainOpen -h plain -c aes-xts-plain64 -q --key-file - "
(
		read o;
		read d;
		read n;
		read k;
		o1=$((o*20480))
		# 10MB steps converted to 512 block counts
		echo -n "$k" | xxd -r -p | sh -c "$cc -o$o1 --readonly \"$d\" \"$n\""
		s2="`head /dev/mapper/"$n" -c 64 | xxd -p | tr -d '\n'`" 
		cryptsetup close "$n"
		s="`echo -n "$k" | xxd -r -p | sha512sum | cut -f1 -d' '`"
		if [ \( "$s" = "$s2" \) -a \( ${#s2} -eq 128 \) ]; then
			o1=$((++o1))
   		echo -n "$k" | xxd -r -p | sh -c "$cc -o$o1 -p1  \"$d\" \"$n\""
		else
				echo "invalid key"
		fi
) 2>&1
# 

